{
    "contents" : "# This is a very simple trend following strategy for testing the results of:\n# Faber, Mebane T., \"A Quantitative Approach to Tactical Asset Allocation.\" \n# Journal of Risk Management (Spring 2007).\n# The article proposes a very simple quantitative market-timing model.  They \n# test the model in sample on the US stock market since 1900 before testing\n# it out-of-sample in twenty other markets.\n\n# The article discusses a 200-day simple moving average, which is proposed\n# in Jeremy Seigel's book \"Stocks for the Long Run\" for timing the DJIA.  He \n# concludes that a simple market timing strategy improves the absolute and\n# risk adjusted returns over a buy-and-hold strategy.  After all transaction\n# costs are included, the timing strategy falls short on the absolute return,\n# but still provides a better risk-adjusted return.  Siegel also tests timing on  \n# the Nasdaq composite since 1972 and finds better absolute and risk adjusted\n# returns.\n\n# The article implements a simpler version of the 200-day SMA, opting for a\n# 10-month SMA.  Monthly data is more easily available for long periods of time,\n# and the lower granularity should translate to lower transaction costs.  \n\n# The rules of the system are relatively simple:\n# - Buy when monthly price > 10-month SMA\n# - Sell and move to cash when monthly price < 10-month SMA\n\n# 1. All entry and exit prices are on the day of the signal at the close.\n# 2. All data series are total return series including dividends, updated monthly. \n#    For the purposes of this demo, we only use price returns.\n# 3. Cash returns are estimated with 90-day commercial paper.  Margin rates for\n#    leveraged models are estimated with the broker call rate.  Again, for the\n#    purposes of this demo, we ignore interest and leverage.\n# 4. Taxes, commissions, and slippage are excluded.\n\n# This simple strategy is different from well-known trend-following systems in\n# three respects.  First, there's no shorting.  Positions are converted to cash on\n# a 'sell' signal, rather than taking a short position. Second, the entire position\n# is put on at trade inception.  No assumptions are made about increasing position\n# size as the trend progresses.  Third, there are no stops.  If the trend reverts\n# quickly, this system will wait for a sell signal before selling the position.\n\n# Data\n# Instead of using total returns data, this demo uses monthly data for the SP500\n# downloaded from Yahoo Finance.  We'll use about 10 years of data, starting at \n# the beginning of 1998.\n\n# Load required libraries\nrequire(quantmod)\nrequire(TTR)\nrequire(blotter)\n\nSys.setenv(TZ=\"UTC\")\n\n# Try to clean up in case the demo was run previously\ntry(rm(\"account.longtrend\",\"portfolio.longtrend\",pos=.blotter),silent=TRUE)\ntry(rm(\"ltaccount\",\"ltportfolio\",\"ClosePrice\",\"CurrentDate\",\"equity\",\"GSPC\",\"i\",\"initDate\",\"initEq\",\"Posn\",\"UnitSize\",\"verbose\"),silent=TRUE)\n\n\n# Set initial values\ninitDate='1997-12-31'\ninitEq=100000\n\n# Load data with quantmod\nprint(\"Loading data\")\ncurrency(\"USD\")\nstock(\"GSPC\",currency=\"USD\",multiplier=1)\ngetSymbols('^GSPC', src='yahoo', index.class=c(\"POSIXt\",\"POSIXct\"),from='1998-01-01')\nGSPC=to.monthly(GSPC, indexAt='endof', drop.time=FALSE)\n\n# Set up indicators with TTR\nprint(\"Setting up indicators\")\nGSPC$SMA10m <- SMA(GSPC[,grep('Adj',colnames(GSPC))], 10)\n\n# Set up a portfolio object and an account object in blotter\nprint(\"Initializing portfolio and account structure\")\nltportfolio='longtrend'\nltaccount='longtrend'\n\ninitPortf(ltportfolio,'GSPC', initDate=initDate)\ninitAcct(ltaccount,portfolios='longtrend', initDate=initDate, initEq=initEq)\nverbose=TRUE\n\n# Create trades\nfor( i in 10:NROW(GSPC) ) { \n    # browser()\n    CurrentDate=time(GSPC)[i]\n    cat(\".\")\n    equity = getEndEq(ltaccount, CurrentDate)\n\n    ClosePrice = as.numeric(Ad(GSPC[i,]))\n    Posn = getPosQty(ltportfolio, Symbol='GSPC', Date=CurrentDate)\n    UnitSize = as.numeric(trunc(equity/ClosePrice))\n\n    # Position Entry (assume fill at close)\n    if( Posn == 0 ) { \n    # No position, so test to initiate Long position\n        if( as.numeric(Ad(GSPC[i,])) > as.numeric(GSPC[i,'SMA10m']) ) { \n            cat('\\n')\n            # Store trade with blotter\n            addTxn(ltportfolio, Symbol='GSPC', TxnDate=CurrentDate, TxnPrice=ClosePrice, TxnQty = UnitSize , TxnFees=0, verbose=verbose)\n        } \n    } else {\n    # Have a position, so check exit\n        if( as.numeric(Ad(GSPC[i,]))  <  as.numeric(GSPC[i,'SMA10m'])) { \n            cat('\\n')\n            # Store trade with blotter\n            addTxn(ltportfolio, Symbol='GSPC', TxnDate=CurrentDate, TxnPrice=ClosePrice, TxnQty = -Posn , TxnFees=0, verbose=verbose)\n        } \n    }\n\n    # Calculate P&L and resulting equity with blotter\n    updatePortf(ltportfolio, Dates = CurrentDate)\n    updateAcct(ltaccount, Dates = CurrentDate)\n    updateEndEq(ltaccount, Dates = CurrentDate)\n} # End dates loop\ncat('\\n')\n\n# Chart results with quantmod\nchart.Posn(ltportfolio, Symbol = 'GSPC', Dates = '1998::')\nplot(add_SMA(n=10,col='darkgreen', on=1))\n\n#look at a transaction summary\ngetTxns(Portfolio=\"longtrend\", Symbol=\"GSPC\")\n\n# Copy the results into the local environment\nprint(\"Retrieving resulting portfolio and account\")\nltportfolio = getPortfolio(\"longtrend\")\nltaccount = getAccount(\"longtrend\")\n\n###############################################################################\n# Blotter: Tools for transaction-oriented trading systems development\n# for R (see http://r-project.org/) \n# Copyright (c) 2008 Peter Carl and Brian G. Peterson\n#\n# This library is distributed under the terms of the GNU Public License (GPL)\n# for full details see the file COPYING\n#\n# $Id: longtrend.R 1483 2013-07-22 01:27:14Z bodanker $\n#\n###############################################################################\n",
    "created" : 1459622861447.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1482765589",
    "id" : "DEC3EC88",
    "lastKnownWriteTime" : 1459442403,
    "path" : "C:/Users/jasen/Personal/blotter/pkg/blotter/demo/longtrend.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "type" : "r_source"
}